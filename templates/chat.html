<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI E-commerce Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html {
      scroll-behavior: smooth;
    }
    .chat-history::-webkit-scrollbar {
      width: 8px;
    }
    .chat-history::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .chat-history::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    .chat-history::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100">
<header class="bg-gray-800 text-white p-4 text-center shadow-md sticky top-0 z-10">
  <h1 class="text-xl font-semibold">AI E-commerce Support Bot</h1>
</header>

<div class="flex-grow container mx-auto max-w-3xl p-4 flex flex-col">
  <div id="chat-history" class="chat-history flex-grow bg-white p-4 space-y-4 overflow-y-auto mb-4 border border-gray-300 rounded-lg shadow-inner">
    {% if not messages %}
    <div class="text-center text-gray-500 italic">Start chatting with the bot!</div>
    {% endif %}
    {% for message in messages %}
    <div class="flex {{ 'justify-end' if message.type == 'human' else 'justify-start' }}">
      <div class="flex items-start gap-2 {{ 'flex-row-reverse' if message.type == 'human' else '' }}">
        <img src="{{ '/static/user-icon.png' if message.type == 'human' else '/static/bot-icon.png' }}" class="w-8 h-8 rounded-full border" alt="avatar">
        <div class="relative group max-w-[75%]">
          <div class="message {{ 'user' if message.type == 'human' else 'assistant' }} p-3 rounded-xl shadow-md transition-all duration-300 {{ 'bg-blue-600 text-white rounded-br-none' if message.type == 'human' else 'bg-gray-200 text-gray-800 rounded-bl-none' }}">
            <p class="text-sm break-words whitespace-pre-wrap">{{ message.content }}</p>
          </div>
          <div class="text-xs text-gray-400 mt-1 text-right select-none">
            {{ message.timestamp or '' }}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <div id="chat-end"></div>
  </div>

  {% if error %}
  <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded relative mb-3 text-sm" role="alert">
    <strong class="font-bold">Error:</strong>
    <span class="block sm:inline">{{ error }}</span>
  </div>
  {% endif %}

  <div class="chat-input p-4 bg-white border-t border-gray-300 rounded-b-lg sticky bottom-0">
    <form action="/chat" class="flex items-center gap-2" method="post" id="chat-form">
      <input name="history_json" type="hidden" id="history-json" value="{{ history_json | e }}">
      <textarea
        autocomplete="off"
        autofocus
        rows="1"
        class="flex-grow resize-none border border-gray-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        name="query"
        id="query-input"
        placeholder="Ask about orders, tracking, returns..."
        required
      ></textarea>
      <button
        aria-label="Send message"
        class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        type="submit"
        id="send-button"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.105 3.105a.75.75 0 0 1 .814-.174l14.64 6.016a.75.75 0 0 1 0 1.379l-14.64 6.016a.75.75 0 0 1-1.015-.99l2.43-6.81a.75.75 0 0 1 .175-.31l-.001-.001L5.39 9.75l-2.43-6.81a.75.75 0 0 1 .145-.834Z"/>
        </svg>
      </button>
    </form>
    <div id="loading-indicator" class="text-sm text-gray-500 mt-2 hidden">Bot is typing...</div>
  </div>
</div>

<script>
  const chatEnd = document.getElementById('chat-end');
  if (chatEnd) chatEnd.scrollIntoView({ behavior: 'smooth' });

  const form = document.getElementById('chat-form');
  const input = document.getElementById('query-input');
  const loadingIndicator = document.getElementById('loading-indicator');

  form.addEventListener('submit', () => {
    loadingIndicator.classList.remove('hidden');
  });

  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      document.getElementById('send-button').click();
    }
  });
</script>
</body>
</html>
